---
- name: "ProxMox SSH í‚¤ ê¸°ë°˜ ì¸ì¦ ì„¤ì • (ê²€ì¦ í¬í•¨)"
  hosts: proxmox
  gather_facts: yes
  vars:
    # SSH ë³´ì•ˆ ì„¤ì •
    ssh_max_auth_tries: 3
    ssh_client_alive_interval: 300
    ssh_client_alive_count_max: 2

  tasks:
    - name: "=== 1ë‹¨ê³„: ì„¤ì • ì „ ì¸ì¦ ë°©ë²• í…ŒìŠ¤íŠ¸ ==="
      debug:
        msg: |
          ================================
          SSH í‚¤ ë°°í¬ ì „ ì¸ì¦ ë°©ë²• í…ŒìŠ¤íŠ¸
          ================================
    
    - name: "í˜„ì¬ ì—°ê²° ë°©ì‹ í™•ì¸"
      debug:
        msg: |
          í˜„ì¬ Ansible ì„¤ì •:
          - ansible_ssh_pass ì •ì˜ë¨: {{ 'Yes' if ansible_ssh_pass is defined else 'No' }}
          - SSH í‚¤ íŒŒì¼ ì •ì˜ë¨: {{ 'Yes' if ansible_ssh_private_key_file is defined else 'No' }}
    
    - name: "ì„¤ì • ì „ SSH í‚¤ ì¸ì¦ í…ŒìŠ¤íŠ¸"
      command: ssh -o PreferredAuthentications=publickey -o ConnectTimeout=5 -o PasswordAuthentication=no -o BatchMode=yes {{ ansible_user }}@{{ ansible_host }} echo "SSH_KEY_TEST"
      delegate_to: localhost
      register: pre_ssh_key_test
      failed_when: false
      changed_when: false

    - name: "ì„¤ì • ì „ ì¸ì¦ ë°©ë²• ë¶„ì„"
      debug:
        msg: |
          í˜„ì¬ ì¸ì¦ ìƒíƒœ ë¶„ì„:
          ================================
          âœ… SSH í‚¤ ì¸ì¦: {{ 'SUCCESS' if pre_ssh_key_test.rc == 0 else 'FAILED' }}
          ğŸ“‹ íŒ¨ìŠ¤ì›Œë“œ ì„¤ì •: {{ 'ìˆìŒ (ansible_ssh_pass ì •ì˜ë¨)' if ansible_ssh_pass is defined else 'ì—†ìŒ' }}
          
          ğŸ’¡ ì‹¤ì œ ì—°ê²° ë°©ì‹: {{ 'SSH í‚¤ê°€ ìš°ì„  ì‚¬ìš©ë¨' if pre_ssh_key_test.rc == 0 else 'SSH í‚¤ ì—†ìŒ - íŒ¨ìŠ¤ì›Œë“œ í•„ìš”' }}
          {{ '   â†’ SSH í‚¤ê°€ ì´ë¯¸ ë°°í¬ë˜ì–´ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤!' if pre_ssh_key_test.rc == 0 else '   â†’ SSH í‚¤ë¥¼ ë°°í¬í•´ì•¼ í•©ë‹ˆë‹¤.' }}
          ================================

    - name: "=== 2ë‹¨ê³„: SSH ì„¤ì • ë°±ì—… ==="
      copy:
        src: /etc/ssh/sshd_config
        dest: "/etc/ssh/sshd_config.backup.{{ ansible_date_time.epoch }}"
        remote_src: yes
        backup: yes

    - name: "=== 3ë‹¨ê³„: SSH ê³µê°œí‚¤ ë°°í¬ ==="
      debug:
        msg: |
          SSH ê³µê°œí‚¤ ë°°í¬ ë‹¨ê³„:
          {{ 'âœ… SSH í‚¤ê°€ ì´ë¯¸ ì‘ë™ ì¤‘ì´ë¯€ë¡œ ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.' if pre_ssh_key_test.rc == 0 else 'ğŸ“‹ SSH í‚¤ë¥¼ ë°°í¬í•©ë‹ˆë‹¤...' }}

    - name: "SSH ê³µê°œí‚¤ ë°°í¬ (ed25519)"
      authorized_key:
        user: "{{ ansible_user }}"
        state: present
        key: "{{ lookup('file', '~/.ssh/id_ed25519.pub') }}"
        comment: "Ansible managed key - {{ ansible_date_time.iso8601 }}"
      register: ssh_key_ed25519
      failed_when: false
      when: pre_ssh_key_test.rc != 0

    - name: "SSH ê³µê°œí‚¤ ë°°í¬ (RSA ë°±ì—…)"
      authorized_key:
        user: "{{ ansible_user }}"
        state: present
        key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
        comment: "Ansible managed RSA key - {{ ansible_date_time.iso8601 }}"
      when: pre_ssh_key_test.rc != 0 and ssh_key_ed25519.failed | default(false)
      register: ssh_key_rsa
      failed_when: false

    - name: "ë¡œì»¬ authorized_keys íŒŒì¼ ì¡´ì¬ í™•ì¸"
      stat:
        path: "~/.ssh/authorized_keys"
      delegate_to: localhost
      register: local_authorized_keys

    - name: "ê¸°ì¡´ authorized_keys ë‚´ìš© ë³µì‚¬"
      block:
        - name: "ë¡œì»¬ authorized_keys ë‚´ìš© ì½ê¸°"
          slurp:
            src: "~/.ssh/authorized_keys"
          delegate_to: localhost
          register: authorized_keys_content

        - name: "ê¸°ì¡´ authorized_keys ë‚´ìš©ì„ ëŒ€ìƒ ì„œë²„ì— ì¶”ê°€"
          blockinfile:
            path: "/home/{{ ansible_user }}/.ssh/authorized_keys"
            block: "{{ authorized_keys_content.content | b64decode }}"
            marker: "# {mark} ANSIBLE MANAGED - ê¸°ì¡´ authorized_keys ë³µì‚¬ë³¸"
            create: yes
            mode: '0600'
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
          register: authorized_keys_copy

        - name: "authorized_keys ë³µì‚¬ ê²°ê³¼"
          debug:
            msg: |
              ğŸ“‹ ê¸°ì¡´ authorized_keys ë³µì‚¬ ì™„ë£Œ:
              - ë¡œì»¬ íŒŒì¼: ~/.ssh/authorized_keys
              - ëŒ€ìƒ ê²½ë¡œ: /home/{{ ansible_user }}/.ssh/authorized_keys
              - ìƒíƒœ: {{ 'SUCCESS' if authorized_keys_copy.changed else 'ALREADY_EXISTS' }}
      when: local_authorized_keys.stat.exists

    - name: "SSH í‚¤ ë°°í¬ ìƒíƒœ í™•ì¸"
      debug:
        msg: |
          SSH í‚¤ ë°°í¬ ê²°ê³¼:
          {{ 'âœ… ì´ë¯¸ SSH í‚¤ ì¸ì¦ì´ ì‘ë™í•˜ë¯€ë¡œ ë°°í¬ ê±´ë„ˆëœ€' if pre_ssh_key_test.rc == 0 else 'ğŸ“‹ ë°°í¬ ì‹œë„ ê²°ê³¼:' }}
          {{ '- ed25519 í‚¤: ' + ('SUCCESS' if ssh_key_ed25519.changed | default(false) else 'SKIPPED/FAILED') if pre_ssh_key_test.rc != 0 else '' }}
          {{ '- RSA í‚¤: ' + ('SUCCESS' if ssh_key_rsa.changed | default(false) else 'SKIPPED/FAILED') if pre_ssh_key_test.rc != 0 else '' }}
          - ê¸°ì¡´ authorized_keys: {{ 'COPIED' if authorized_keys_copy.changed | default(false) else ('NOT_FOUND' if not local_authorized_keys.stat.exists | default(false) else 'ALREADY_EXISTS') }}

    - name: "=== 4ë‹¨ê³„: SSH í‚¤ ë°°í¬ í›„ ì¤‘ê°„ í…ŒìŠ¤íŠ¸ ==="
      debug:
        msg: "SSH í‚¤ê°€ ì œëŒ€ë¡œ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤..."

    - name: "SSH í‚¤ ì¸ì¦ ì¤‘ê°„ í…ŒìŠ¤íŠ¸"
      command: ssh -o PreferredAuthentications=publickey -o ConnectTimeout=10 -o PasswordAuthentication=no -o BatchMode=yes {{ ansible_user }}@{{ ansible_host }} echo "SSH_KEY_SUCCESS"
      delegate_to: localhost
      register: mid_ssh_key_test
      failed_when: false
      changed_when: false

    - name: "SSH í‚¤ ë°°í¬ ê²€ì¦"
      debug:
        msg: |
          SSH í‚¤ ë°°í¬ í›„ í…ŒìŠ¤íŠ¸:
          - SSH í‚¤ ì¸ì¦: {{ 'SUCCESS âœ…' if mid_ssh_key_test.rc == 0 else 'FAILED âŒ' }}
          
    - name: "SSH í‚¤ ì¸ì¦ ì‹¤íŒ¨ì‹œ ì¤‘ë‹¨"
      fail:
        msg: |
          âŒ SSH í‚¤ ì¸ì¦ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!
          ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:
          1. ê³µê°œí‚¤ íŒŒì¼ ì¡´ì¬: ~/.ssh/id_ed25519.pub ë˜ëŠ” ~/.ssh/id_rsa.pub
          2. SSH ì„œë¹„ìŠ¤ ìƒíƒœ
          3. ë„¤íŠ¸ì›Œí¬ ì—°ê²°
      when: mid_ssh_key_test.rc != 0

    - name: "=== 5ë‹¨ê³„: SSH ë³´ì•ˆ ì„¤ì • ê°•í™” ==="
      debug:
        msg: "SSH ë³´ì•ˆ ì„¤ì •ì„ ê°•í™”í•©ë‹ˆë‹¤..."

    - name: "SSH ì„¤ì • ê°•í™” - PasswordAuthentication ë¹„í™œì„±í™”"
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication no'
        backup: yes
      notify: restart_ssh_and_verify

    - name: "Cloud-init SSH ì„¤ì • íŒŒì¼ í™•ì¸"
      stat:
        path: /etc/ssh/sshd_config.d/50-cloud-init.conf
      register: cloud_init_ssh_config

    - name: "Cloud-init SSH ì„¤ì •ì—ì„œ PasswordAuthentication ë¹„í™œì„±í™”"
      lineinfile:
        path: /etc/ssh/sshd_config.d/50-cloud-init.conf
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication no'
        backup: yes
      when: cloud_init_ssh_config.stat.exists
      register: cloud_init_config_changed

    - name: "SSH ì„œë¹„ìŠ¤ ì¬ì‹œì‘ (cloud-init ì„¤ì • ë³€ê²½ì‹œ)"
      service:
        name: ssh
        state: restarted
      when: cloud_init_config_changed.changed | default(false)

    - name: "SSH ì„¤ì • ê°•í™” - MaxAuthTries ì„¤ì •"
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?MaxAuthTries'
        line: "MaxAuthTries {{ ssh_max_auth_tries }}"

    - name: "SSH ì„¤ì • ê°•í™” - ClientAliveInterval ì„¤ì •"
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?ClientAliveInterval'
        line: "ClientAliveInterval {{ ssh_client_alive_interval }}"

    - name: "SSH ì„¤ì • ê°•í™” - ClientAliveCountMax ì„¤ì •"
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?ClientAliveCountMax'
        line: "ClientAliveCountMax {{ ssh_client_alive_count_max }}"

    - name: "SSH ì„¤ì • ê°•í™” - PermitEmptyPasswords ë¹„í™œì„±í™”"
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitEmptyPasswords'
        line: 'PermitEmptyPasswords no'

    - name: "SSH ì„¤ì • ê°•í™” - X11Forwarding ë¹„í™œì„±í™”"
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?X11Forwarding'
        line: 'X11Forwarding no'

    - name: "SSH ì„¤ì • ë¬¸ë²• í™•ì¸"
      command: sshd -t
      changed_when: false

  handlers:
    - name: restart_ssh_and_verify
      block:
        - name: "SSH ì„œë¹„ìŠ¤ ì¬ì‹œì‘"
          service:
            name: ssh
            state: restarted

        - name: "SSH ì¬ì‹œì‘ í›„ ëŒ€ê¸° (10ì´ˆ)"
          wait_for:
            port: 22
            host: "{{ ansible_host }}"
            timeout: 30
          delegate_to: localhost

        - name: "=== 6ë‹¨ê³„: ìµœì¢… ì¸ì¦ ë°©ë²• ê²€ì¦ ==="
          debug:
            msg: "SSH ë³´ì•ˆ ì„¤ì • í›„ ì¸ì¦ ë°©ë²•ì„ ê²€ì¦í•©ë‹ˆë‹¤..."

        - name: "ìµœì¢… SSH í‚¤ ì¸ì¦ í…ŒìŠ¤íŠ¸"
          command: ssh -o PreferredAuthentications=publickey -o ConnectTimeout=10 -o PasswordAuthentication=no -o BatchMode=yes {{ ansible_user }}@{{ ansible_host }} echo "SSH_KEY_FINAL_TEST"
          delegate_to: localhost
          register: final_ssh_key_test
          failed_when: false
          changed_when: false

        - name: "ìµœì¢… íŒ¨ìŠ¤ì›Œë“œ ì¸ì¦ í…ŒìŠ¤íŠ¸"
          command: ssh -o PreferredAuthentications=password -o ConnectTimeout=5 -o PubkeyAuthentication=no -o StrictHostKeyChecking=no -o BatchMode=yes {{ ansible_user }}@{{ ansible_host }} echo "PASSWORD_TEST"
          delegate_to: localhost
          register: final_password_test
          failed_when: false
          changed_when: false

        - name: "ğŸ‰ ìµœì¢… ê²€ì¦ ê²°ê³¼"
          debug:
            msg: |
              ================================
              SSH ì¸ì¦ ë°©ë²• ìµœì¢… ê²€ì¦ ê²°ê³¼
              ================================
              
              âœ… SSH í‚¤ ì¸ì¦: {{ 'SUCCESS' if final_ssh_key_test.rc == 0 else 'FAILED' }}
              âŒ íŒ¨ìŠ¤ì›Œë“œ ì¸ì¦: {{ 'BLOCKED (ë³´ì•ˆ ê°•í™”ë¨)' if final_password_test.rc != 0 else 'WARNING: ì—¬ì „íˆ í™œì„±í™”ë¨' }}
              
              {{ 'ğŸ‰ SSH í‚¤ ê¸°ë°˜ ì¸ì¦ ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!' if final_ssh_key_test.rc == 0 else 'âš ï¸  ì„¤ì •ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.' }}
              
              ì—°ê²° í…ŒìŠ¤íŠ¸ ë°©ë²•:
              ==================
              1. Ansibleë¡œ í…ŒìŠ¤íŠ¸:
                 ansible {{ inventory_hostname }} -m ping
              
              2. SSH í‚¤ë¡œ ì§ì ‘ ì—°ê²°:
                 ssh {{ ansible_user }}@{{ ansible_host }}
              
              3. íŒ¨ìŠ¤ì›Œë“œ ì—°ê²° ì‹œë„ (ì‹¤íŒ¨í•´ì•¼ ì •ìƒ):
                 ssh -o PreferredAuthentications=password {{ ansible_user }}@{{ ansible_host }}
                 â†’ "Permission denied" ë©”ì‹œì§€ê°€ ë‚˜ì™€ì•¼ í•¨
              
              ================================
