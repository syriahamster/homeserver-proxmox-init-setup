---
- name: "ProxMox VE APT ì €ì¥ì†Œ ìë™ ì„¤ì •"
  hosts: proxmox
  gather_facts: yes
  vars:
    # ì‚¬ìš©ì ì„¤ì • (í•„ìš”ì— ë”°ë¼ ìˆ˜ì • ê°€ëŠ¥)
    setup_no_subscription_repo: true
    disable_enterprise_repos: true
    auto_update_cache: true
    show_detailed_info: true

  tasks:
    - name: "=== ProxMox VE APT ì €ì¥ì†Œ ìë™ ì„¤ì • ì‹œì‘ ==="
      debug:
        msg: |
          ================================
          ProxMox VE APT ì €ì¥ì†Œ ìë™ ì„¤ì •
          ================================
          
          ğŸ¯ ëª©ì : ProxMox VEì˜ APT ì €ì¥ì†Œ ë¬¸ì œ í•´ê²°
          ğŸ“‹ ì‘ì—… ë‚´ìš©:
          1. í˜„ì¬ ì €ì¥ì†Œ ìƒíƒœ í™•ì¸
          2. Enterprise ì €ì¥ì†Œ ë¹„í™œì„±í™” (401 Unauthorized ì—ëŸ¬ í•´ê²°)
          3. No-Subscription ì €ì¥ì†Œ í™œì„±í™” (ë¬´ë£Œ)
          4. APT íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸
          5. ì„¤ì • ê²€ì¦
          
          âš ï¸ ì°¸ê³ : No-Subscription ì €ì¥ì†ŒëŠ” ë¬´ë£Œì´ì§€ë§Œ ìƒì—…ì  ì§€ì›ì´ ì—†ìŠµë‹ˆë‹¤.
          ================================

    - name: "1ë‹¨ê³„: í˜„ì¬ ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸"
      debug:
        msg: |
          ì‹œìŠ¤í…œ ì •ë³´:
          - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          - ì•„í‚¤í…ì²˜: {{ ansible_architecture }}
          - í˜¸ìŠ¤íŠ¸ëª…: {{ ansible_hostname }}

    - name: "2ë‹¨ê³„: í˜„ì¬ APT ì €ì¥ì†Œ ìƒíƒœ í™•ì¸"
      shell: |
        echo "=== í˜„ì¬ ì €ì¥ì†Œ íŒŒì¼ ëª©ë¡ ==="
        ls -la /etc/apt/sources.list.d/ | grep -E "(pve|ceph)" || echo "ProxMox ì €ì¥ì†Œ íŒŒì¼ ì—†ìŒ"
        
        echo -e "\n=== APT ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸ (ì—ëŸ¬ í™•ì¸ìš©) ==="
        apt update 2>&1 | grep -E "(401|Unauthorized|enterprise)" || echo "Enterprise ì €ì¥ì†Œ ê´€ë ¨ ì—ëŸ¬ ì—†ìŒ"
      register: current_status
      changed_when: false
      failed_when: false

    - name: "í˜„ì¬ ìƒíƒœ ì¶œë ¥"
      debug:
        msg: |
          í˜„ì¬ APT ì €ì¥ì†Œ ìƒíƒœ:
          {{ current_status.stdout }}
      when: show_detailed_info | default(true)

    - name: "3ë‹¨ê³„: Enterprise ì €ì¥ì†Œ ë¹„í™œì„±í™”"
      block:
        - name: "Enterprise ì €ì¥ì†Œ .sources íŒŒì¼ ë¹„í™œì„±í™”"
          shell: |
            for file in /etc/apt/sources.list.d/pve-enterprise.sources /etc/apt/sources.list.d/ceph.sources; do
              if [ -f "$file" ]; then
                echo "ë¹„í™œì„±í™”: $file"
                mv "$file" "$file.disabled"
              else
                echo "íŒŒì¼ ì—†ìŒ: $file"
              fi
            done
          register: disable_sources
          when: disable_enterprise_repos | default(true)

        - name: "Enterprise ì €ì¥ì†Œ .list íŒŒì¼ ë¹„í™œì„±í™”"
          lineinfile:
            path: "{{ item }}"
            regexp: '^deb https://enterprise.proxmox.com'
            line: '# deb https://enterprise.proxmox.com (ë¹„í™œì„±í™” - êµ¬ë… í•„ìš”)'
            create: yes
            backup: yes
          loop:
            - /etc/apt/sources.list.d/pve-enterprise.list
            - /etc/apt/sources.list.d/ceph.list
          when: disable_enterprise_repos | default(true)
          failed_when: false

        - name: "Enterprise ì €ì¥ì†Œ ë¹„í™œì„±í™” ê²°ê³¼"
          debug:
            msg: |
              Enterprise ì €ì¥ì†Œ ë¹„í™œì„±í™” ì™„ë£Œ:
              {{ disable_sources.stdout if disable_sources is defined else 'ì‘ì—… ê±´ë„ˆëœ€' }}

    - name: "4ë‹¨ê³„: No-Subscription ì €ì¥ì†Œ í™œì„±í™”"
      block:
        - name: "ProxMox No-Subscription ì €ì¥ì†Œ ì¶”ê°€"
          copy:
            content: |
              # ProxMox VE No-Subscription Repository (ë¬´ë£Œ)
              # ì´ ì €ì¥ì†ŒëŠ” ë¬´ë£Œì´ì§€ë§Œ ìƒì—…ì  ì§€ì›ì´ ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤
              # í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” Enterprise êµ¬ë…ì„ ê¶Œì¥í•©ë‹ˆë‹¤
              # 
              # ì¶”ê°€ ë‚ ì§œ: {{ ansible_date_time.iso8601 }}
              # ê´€ë¦¬ì: Ansible ìë™ ì„¤ì •
              
              deb http://download.proxmox.com/debian/pve {{ ansible_distribution_release }} pve-no-subscription
            dest: /etc/apt/sources.list.d/pve-no-subscription.list
            backup: yes
            owner: root
            group: root
            mode: '0644'
          when: setup_no_subscription_repo | default(true)

        - name: "ì €ì¥ì†Œ ì¶”ê°€ í™•ì¸"
          debug:
            msg: |
              âœ… No-Subscription ì €ì¥ì†Œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤
              íŒŒì¼: /etc/apt/sources.list.d/pve-no-subscription.list
              ë‚´ìš©: deb http://download.proxmox.com/debian/pve {{ ansible_distribution_release }} pve-no-subscription

    - name: "5ë‹¨ê³„: APT íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸"
      block:
        - name: "APT ìºì‹œ ì—…ë°ì´íŠ¸ ì‹¤í–‰"
          apt:
            update_cache: yes
            cache_valid_time: 0
            force_apt_get: yes
          register: apt_update_result
          when: auto_update_cache | default(true)

        - name: "APT ì—…ë°ì´íŠ¸ ê²°ê³¼ í™•ì¸"
          debug:
            msg: |
              {{ 'âœ… APT íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸ ì„±ê³µ!' if apt_update_result.changed else 'âœ… APT ìºì‹œê°€ ì´ë¯¸ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤.' }}
          when: auto_update_cache | default(true)

    - name: "6ë‹¨ê³„: ì„¤ì • ê²€ì¦ ë° í…ŒìŠ¤íŠ¸"
      block:
        - name: "ì €ì¥ì†Œ ì„¤ì • ê²€ì¦"
          shell: |
            echo "=== í™œì„±í™”ëœ ì €ì¥ì†Œ í™•ì¸ ==="
            echo "ProxMox ì €ì¥ì†Œ:"
            grep -h "^deb.*proxmox" /etc/apt/sources.list.d/*.list 2>/dev/null || echo "  ì—†ìŒ"
            
            echo -e "\nDebian ê¸°ë³¸ ì €ì¥ì†Œ:"  
            grep -h "^deb.*debian" /etc/apt/sources.list /etc/apt/sources.list.d/*.sources 2>/dev/null | head -2 || echo "  ì—†ìŒ"
            
            echo -e "\n=== ë¹„í™œì„±í™”ëœ Enterprise ì €ì¥ì†Œ í™•ì¸ ==="
            ls -la /etc/apt/sources.list.d/ | grep -E "(disabled|enterprise)" || echo "  ë¹„í™œì„±í™”ëœ íŒŒì¼ ì—†ìŒ"
            
            echo -e "\n=== ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€ í™•ì¸ ==="
            apt list --upgradable 2>/dev/null | head -5 || echo "  ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€ ì—†ìŒ"
          register: verification_result
          changed_when: false

        - name: "ê²€ì¦ ê²°ê³¼ ì¶œë ¥"
          debug:
            msg: |
              ì €ì¥ì†Œ ì„¤ì • ê²€ì¦ ê²°ê³¼:
              {{ verification_result.stdout }}

    - name: "ğŸ‰ ì„¤ì • ì™„ë£Œ ë° ì‚¬ìš© ì•ˆë‚´"
      debug:
        msg: |
          ================================
          ğŸ‰ ProxMox VE APT ì €ì¥ì†Œ ì„¤ì • ì™„ë£Œ!
          ================================
          
          âœ… ì™„ë£Œëœ ì‘ì—…:
          â€¢ Enterprise ì €ì¥ì†Œ ë¹„í™œì„±í™” (401 Unauthorized ì—ëŸ¬ í•´ê²°)
          â€¢ No-Subscription ì €ì¥ì†Œ í™œì„±í™”
          â€¢ APT íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸ ì™„ë£Œ
          â€¢ ì €ì¥ì†Œ ì„¤ì • ê²€ì¦ ì™„ë£Œ
          
          ğŸ“‹ ì´ì œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹:
          
          1. íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸:
             apt update
          
          2. ì‹œìŠ¤í…œ ì—…ê·¸ë ˆì´ë“œ:
             apt upgrade
             
          3. íŠ¹ì • íŒ¨í‚¤ì§€ ì„¤ì¹˜:
             apt install <íŒ¨í‚¤ì§€ëª…>
             
          4. ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€ í™•ì¸:
             apt list --upgradable
          
          ğŸŒ ProxMox ì›¹ ê´€ë¦¬ í˜ì´ì§€:
             https://{{ ansible_host }}:8006
          
          âš ï¸ ì¤‘ìš” ì°¸ê³ ì‚¬í•­:
          â€¢ No-Subscription ì €ì¥ì†ŒëŠ” ë¬´ë£Œì´ì§€ë§Œ ìƒì—…ì  ì§€ì›ì´ ì—†ìŠµë‹ˆë‹¤
          â€¢ í”„ë¡œë•ì…˜(ìš´ì˜) í™˜ê²½ì—ì„œëŠ” Enterprise êµ¬ë…ì„ ê¶Œì¥í•©ë‹ˆë‹¤
          â€¢ ì •ê¸°ì ì¸ ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ì™€ ë°±ì—…ì„ ìŠì§€ ë§ˆì„¸ìš”!
          â€¢ ì´ ì„¤ì •ì€ ì–¸ì œë“ ì§€ ë˜ëŒë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤
          
          ğŸ”„ ì„¤ì • ë˜ëŒë¦¬ê¸° (í•„ìš”ì‹œ):
          â€¢ Enterprise ì €ì¥ì†Œ ì¬í™œì„±í™”:
            mv /etc/apt/sources.list.d/pve-enterprise.sources.disabled /etc/apt/sources.list.d/pve-enterprise.sources
          â€¢ No-Subscription ì €ì¥ì†Œ ì œê±°:
            rm /etc/apt/sources.list.d/pve-no-subscription.list
          
          ================================
