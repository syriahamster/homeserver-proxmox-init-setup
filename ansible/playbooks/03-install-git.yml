---
- name: "Git ë° ê°œë°œ ë„êµ¬ ì„¤ì¹˜"
  hosts: proxmox
  gather_facts: yes
  vars:
    # Git ì„¤ì •
    git_user_name: ""           # ì‚¬ìš©ìê°€ í•„ìš”ì‹œ ì„¤ì •
    git_user_email: ""          # ì‚¬ìš©ìê°€ í•„ìš”ì‹œ ì„¤ì •
    
    # ì„¤ì¹˜í•  íŒ¨í‚¤ì§€ ëª©ë¡ (Debian/ProxMox í˜¸í™˜)
    development_packages:
      - git
      - curl
      - wget
      - vim
      - htop
      - tree
      - unzip
      - build-essential
    
    # ì„ íƒì  íŒ¨í‚¤ì§€
    optional_packages:
      - nano
      - screen
      - tmux
      - rsync

  tasks:
    - name: "=== Git ë° ê°œë°œ ë„êµ¬ ì„¤ì¹˜ ì‹œì‘ ==="
      debug:
        msg: |
          ================================
          Git ë° ê°œë°œ ë„êµ¬ ìë™ ì„¤ì¹˜
          ================================
          
          ğŸ¯ ëª©ì : ProxMox ì„œë²„ì— ê°œë°œ ë° ê´€ë¦¬ ë„êµ¬ ì„¤ì¹˜
          ğŸ“‹ ì„¤ì¹˜ ì˜ˆì • íŒ¨í‚¤ì§€:
          â€¢ Git (ë²„ì „ ê´€ë¦¬)
          â€¢ Curl/Wget (ë‹¤ìš´ë¡œë“œ ë„êµ¬)
          â€¢ Vim/Nano (í…ìŠ¤íŠ¸ ì—ë””í„°)
          â€¢ Htop (ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§)
          â€¢ Build-essential (ì»´íŒŒì¼ ë„êµ¬)
          â€¢ ê¸°íƒ€ ìœ ìš©í•œ ì‹œìŠ¤í…œ ë„êµ¬ë“¤
          
          â±ï¸ ì˜ˆìƒ ì†Œìš”ì‹œê°„: 2-5ë¶„
          ================================

    - name: "1ë‹¨ê³„: í˜„ì¬ ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸"
      debug:
        msg: |
          ì‹œìŠ¤í…œ ì •ë³´:
          - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          - ì•„í‚¤í…ì²˜: {{ ansible_architecture }}
          - ì‚¬ìš© ê°€ëŠ¥í•œ ë©”ëª¨ë¦¬: {{ ansible_memfree_mb }}MB

    - name: "2ë‹¨ê³„: APT íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸"
      apt:
        update_cache: yes
        cache_valid_time: 3600
      register: apt_update_result

    - name: "APT ì—…ë°ì´íŠ¸ ê²°ê³¼"
      debug:
        msg: |
          {{ 'âœ… APT íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸ ì™„ë£Œ' if apt_update_result.changed else 'âœ… APT ìºì‹œê°€ ìµœì‹  ìƒíƒœ' }}

    - name: "3ë‹¨ê³„: í•„ìˆ˜ ê°œë°œ ë„êµ¬ ì„¤ì¹˜"
      apt:
        name: "{{ development_packages }}"
        state: present
        update_cache: no
      register: package_install_result

    - name: "í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ê²°ê³¼"
      debug:
        msg: |
          í•„ìˆ˜ ê°œë°œ ë„êµ¬ ì„¤ì¹˜ ê²°ê³¼:
          {{ 'âœ… ìƒˆ íŒ¨í‚¤ì§€ê°€ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤' if package_install_result.changed else 'âœ… ëª¨ë“  íŒ¨í‚¤ì§€ê°€ ì´ë¯¸ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤' }}

    - name: "4ë‹¨ê³„: ì„ íƒì  ë„êµ¬ ì„¤ì¹˜"
      apt:
        name: "{{ optional_packages }}"
        state: present
        update_cache: no
      register: optional_install_result
      failed_when: false

    - name: "ì„ íƒì  íŒ¨í‚¤ì§€ ì„¤ì¹˜ ê²°ê³¼"
      debug:
        msg: |
          ì„ íƒì  ë„êµ¬ ì„¤ì¹˜ ê²°ê³¼:
          {{ 'âœ… ì¶”ê°€ ë„êµ¬ê°€ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤' if optional_install_result.changed else 'âœ… ì„ íƒì  ë„êµ¬ë“¤ì´ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆê±°ë‚˜ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }}

    - name: "5ë‹¨ê³„: Git ì„¤ì¹˜ í™•ì¸ ë° ë²„ì „ ì²´í¬"
      command: git --version
      register: git_version_check
      changed_when: false

    - name: "Git ì„¤ì¹˜ í™•ì¸ ê²°ê³¼"
      debug:
        msg: |
          Git ì„¤ì¹˜ ìƒíƒœ:
          {{ git_version_check.stdout }}

    - name: "6ë‹¨ê³„: ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ ëª©ë¡ í™•ì¸"
      shell: |
        echo "=== ì„¤ì¹˜ëœ ê°œë°œ ë„êµ¬ ë²„ì „ ==="
        echo "Git: $(git --version 2>/dev/null || echo 'ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ')"
        echo "Curl: $(curl --version 2>/dev/null | head -1 || echo 'ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ')"
        echo "Vim: $(vim --version 2>/dev/null | head -1 || echo 'ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ')"
        echo "Htop: $(htop --version 2>/dev/null | head -1 || echo 'ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ')"
        
        echo -e "\n=== ì‹œìŠ¤í…œ ë„êµ¬ ==="
        echo "Tree: $(tree --version 2>/dev/null | head -1 || echo 'ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ')"
        echo "Unzip: $(unzip -v 2>/dev/null | head -1 || echo 'ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ')"
        
        echo -e "\n=== ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ==="
        df -h / | tail -1 | awk '{print "ì‚¬ìš©ëŸ‰: " $3 "/" $2 " (" $5 ")"}'
        
        echo -e "\n=== ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ==="
        free -h | grep "^Mem" | awk '{print "ë©”ëª¨ë¦¬: " $3 "/" $2}'
      register: system_info
      changed_when: false

    - name: "ì‹œìŠ¤í…œ ìƒíƒœ ë° ë„êµ¬ í™•ì¸ ê²°ê³¼"
      debug:
        msg: |
          í˜„ì¬ ì‹œìŠ¤í…œ ìƒíƒœ:
          {{ system_info.stdout }}

    - name: "7ë‹¨ê³„: Git ì „ì—­ ì„¤ì • (ì„ íƒì‚¬í•­)"
      block:
        - name: "Git ì‚¬ìš©ì ì´ë¦„ ì„¤ì •"
          git_config:
            name: user.name
            value: "{{ git_user_name }}"
            scope: global
          when: git_user_name != ""

        - name: "Git ì‚¬ìš©ì ì´ë©”ì¼ ì„¤ì •"
          git_config:
            name: user.email
            value: "{{ git_user_email }}"
            scope: global
          when: git_user_email != ""

        - name: "Git ê¸°ë³¸ ë¸Œëœì¹˜ ì„¤ì • (main)"
          git_config:
            name: init.defaultBranch
            value: main
            scope: global

        - name: "Git ì„¤ì • í™•ì¸"
          shell: |
            echo "=== Git ì „ì—­ ì„¤ì • ==="
            git config --global --list | grep -E "(user\.|init\.)" || echo "Git ì‚¬ìš©ì ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤"
          register: git_config_check
          changed_when: false

        - name: "Git ì„¤ì • ê²°ê³¼ ì¶œë ¥"
          debug:
            msg: |
              Git ì„¤ì • ìƒíƒœ:
              {{ git_config_check.stdout }}

    - name: "ğŸ‰ ì„¤ì¹˜ ì™„ë£Œ ë° ì‚¬ìš© ì•ˆë‚´"
      debug:
        msg: |
          ================================
          ğŸ‰ Git ë° ê°œë°œ ë„êµ¬ ì„¤ì¹˜ ì™„ë£Œ!
          ================================
          
          âœ… ì„¤ì¹˜ëœ ë„êµ¬ë“¤:
          â€¢ Git - ë²„ì „ ê´€ë¦¬ ì‹œìŠ¤í…œ
          â€¢ Curl/Wget - íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë„êµ¬
          â€¢ Vim/Nano - í…ìŠ¤íŠ¸ ì—ë””í„°
          â€¢ Htop - ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§
          â€¢ Tree - ë””ë ‰í„°ë¦¬ êµ¬ì¡° í‘œì‹œ
          â€¢ Build-essential - ì»´íŒŒì¼ í™˜ê²½
          
          ğŸ“‹ ì´ì œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹:
          
          1. Git ì €ì¥ì†Œ ë³µì œ:
             git clone <ì €ì¥ì†Œ URL>
          
          2. ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§:
             htop                    # ì‹¤ì‹œê°„ í”„ë¡œì„¸ìŠ¤ ëª¨ë‹ˆí„°
             tree /path              # ë””ë ‰í„°ë¦¬ êµ¬ì¡° í‘œì‹œ
             
          3. íŒŒì¼ ë‹¤ìš´ë¡œë“œ:
             curl -O <URL>           # íŒŒì¼ ë‹¤ìš´ë¡œë“œ
             wget <URL>              # íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          
          4. í…ìŠ¤íŠ¸ í¸ì§‘:
             vim <íŒŒì¼ëª…>            # Vim ì—ë””í„°
             nano <íŒŒì¼ëª…>           # Nano ì—ë””í„°
          
          ğŸ’¡ Git ì‚¬ìš©ì„ ìœ„í•œ ì¶”ê°€ ì„¤ì •:
          
          Git ì‚¬ìš©ì ì •ë³´ ì„¤ì • (ìµœì´ˆ 1íšŒ):
          git config --global user.name "Your Name"
          git config --global user.email "your.email@example.com"
          
          SSH í‚¤ ìƒì„± (GitHub/GitLab ì—°ê²°ìš©):
          ssh-keygen -t ed25519 -C "your.email@example.com"
          
          ğŸ”§ ProxMox ê´€ë¦¬ì— ìœ ìš©í•œ ëª…ë ¹ë“¤:
          - htop: ì‹¤ì‹œê°„ ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§
          - tree: ë””ë ‰í„°ë¦¬ êµ¬ì¡° í™•ì¸
          - curl: API í˜¸ì¶œ ë° íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          - git: ì„¤ì • íŒŒì¼ ë²„ì „ ê´€ë¦¬
          
          ================================
