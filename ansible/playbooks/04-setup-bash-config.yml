---
- name: "Bash ì„¤ì • ë° ì»¤ìŠ¤í„°ë§ˆì´ì§•"
  hosts: proxmox
  gather_facts: yes
  vars:
    # Bash ì„¤ì • ì˜µì…˜
    bash_history_size: 10000    # íˆìŠ¤í† ë¦¬ ìµœëŒ€ ì €ì¥ ê°œìˆ˜
    bash_history_filesize: 20000  # íˆìŠ¤í† ë¦¬ íŒŒì¼ ìµœëŒ€ í¬ê¸°
    enable_git_branch: true     # Git ë¸Œëœì¹˜ í‘œì‹œ í™œì„±í™”
    enable_colored_prompt: true # ì»¬ëŸ¬ í”„ë¡¬í”„íŠ¸ í™œì„±í™”
    
    # ì‚¬ìš©ìë³„ ì„¤ì • ì ìš© (root ë° ì¶”ê°€ ì‚¬ìš©ìë“¤)
    target_users:
      - root
    
  tasks:
    - name: "=== Bash ì„¤ì • ë° ì»¤ìŠ¤í„°ë§ˆì´ì§• ì‹œì‘ ==="
      debug:
        msg: |
          ================================
          Bash ì„¤ì • ë° ì»¤ìŠ¤í„°ë§ˆì´ì§•
          ================================
          
          ğŸ¯ ëª©ì : ProxMox ì„œë²„ì˜ Bash í™˜ê²½ ê°œì„ 
          ğŸ“‹ ì„¤ì • ë‚´ìš©:
          â€¢ History ëª…ë ¹ì–´ì— ì‹œê°„ í‘œì‹œ ì¶”ê°€
          â€¢ Git ë¸Œëœì¹˜ëª… í”„ë¡¬í”„íŠ¸ í‘œì‹œ
          â€¢ ì»¬ëŸ¬ í”„ë¡¬í”„íŠ¸ í™œì„±í™”
          â€¢ ìœ ìš©í•œ alias ë° í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          â€¢ History í¬ê¸° ì¦ê°€ ë° ì¤‘ë³µ ì œê±°
          
          ğŸ‘¥ ì ìš© ëŒ€ìƒ ì‚¬ìš©ì: {{ target_users | join(', ') }}
          
          â±ï¸ ì˜ˆìƒ ì†Œìš”ì‹œê°„: 1-2ë¶„
          ================================

    - name: "1ë‹¨ê³„: í˜„ì¬ ì‹œìŠ¤í…œ ë° ì‚¬ìš©ì ì •ë³´ í™•ì¸"
      debug:
        msg: |
          ì‹œìŠ¤í…œ ì •ë³´:
          - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          - Bash ë²„ì „: {{ ansible_env.BASH_VERSION | default('í™•ì¸ ë¶ˆê°€') }}
          - í˜„ì¬ ì‚¬ìš©ì: {{ ansible_user_id }}
          - í™ˆ ë””ë ‰í„°ë¦¬: {{ ansible_env.HOME }}

    - name: "2ë‹¨ê³„: ê¸°ì¡´ .bashrc ë°±ì—…"
      copy:
        src: "{{ '/home/' + item + '/.bashrc' if item != 'root' else '/root/.bashrc' }}"
        dest: "{{ '/home/' + item + '/.bashrc.backup.' + ansible_date_time.epoch if item != 'root' else '/root/.bashrc.backup.' + ansible_date_time.epoch }}"
        remote_src: yes
        backup: no
      loop: "{{ target_users }}"
      register: bashrc_backup
      failed_when: false

    - name: "ë°±ì—… ì™„ë£Œ í™•ì¸"
      debug:
        msg: |
          âœ… ê¸°ì¡´ .bashrc íŒŒì¼ë“¤ì´ ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤
          ë°±ì—… íŒŒì¼ëª…ì—ëŠ” íƒ€ì„ìŠ¤íƒ¬í”„ê°€ í¬í•¨ë©ë‹ˆë‹¤

    - name: "3ë‹¨ê³„: ì‚¬ìš©ìë³„ .bashrc ì„¤ì • ì ìš©"
      blockinfile:
        path: "{{ '/home/' + item + '/.bashrc' if item != 'root' else '/root/.bashrc' }}"
        marker: "# {mark} ANSIBLE MANAGED BASH CUSTOMIZATION"
        block: |
          # ================================
          # ProxMox Bash ì»¤ìŠ¤í„°ë§ˆì´ì§• ì„¤ì •
          # ================================
          
          # History ì„¤ì • - ëª…ë ¹ì–´ ì‹¤í–‰ ì‹œê°„ í‘œì‹œ
          export HISTTIMEFORMAT="%F %T "
          export HISTSIZE={{ bash_history_size }}
          export HISTFILESIZE={{ bash_history_filesize }}
          export HISTCONTROL=ignoreboth:erasedups  # ì¤‘ë³µ ëª…ë ¹ì–´ ì œê±°
          
          # History ì¦‰ì‹œ ì €ì¥ (ì—¬ëŸ¬ ì„¸ì…˜ì—ì„œ ê³µìœ )
          shopt -s histappend
          PROMPT_COMMAND="history -a; history -c; history -r; $PROMPT_COMMAND"
          
          # Git ë¸Œëœì¹˜ í‘œì‹œ í•¨ìˆ˜
          {% if enable_git_branch %}
          parse_git_branch() {
              git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/ (\1)/'
          }
          {% endif %}
          
          # ì»¬ëŸ¬ í”„ë¡¬í”„íŠ¸ ì„¤ì •
          {% if enable_colored_prompt %}
          if [ "$color_prompt" = yes ]; then
              # Root ì‚¬ìš©ìëŠ” ë¹¨ê°„ìƒ‰, ì¼ë°˜ ì‚¬ìš©ìëŠ” ì´ˆë¡ìƒ‰
              if [ "$EUID" -eq 0 ]; then
                  {% if enable_git_branch %}
                  PS1='\[\033[01;31m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[01;33m\]$(parse_git_branch)\[\033[00m\]\$ '
                  {% else %}
                  PS1='\[\033[01;31m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
                  {% endif %}
              else
                  {% if enable_git_branch %}
                  PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[01;33m\]$(parse_git_branch)\[\033[00m\]\$ '
                  {% else %}
                  PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
                  {% endif %}
              fi
          else
              {% if enable_git_branch %}
              PS1='\u@\h:\w$(parse_git_branch)\$ '
              {% else %}
              PS1='\u@\h:\w\$ '
              {% endif %}
          fi
          {% endif %}
          
          # ================================
          # ProxMox Bash ì»¤ìŠ¤í„°ë§ˆì´ì§• ë
          # ================================
          
        create: yes
        backup: yes
      loop: "{{ target_users }}"
      register: bashrc_update

    - name: "Bash ì„¤ì • ì ìš© ê²°ê³¼"
      debug:
        msg: |
          âœ… ëª¨ë“  ì‚¬ìš©ìì˜ .bashrc íŒŒì¼ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤

    - name: "4ë‹¨ê³„: .bash_profile ì„¤ì • (ë¡œê·¸ì¸ ì‹œ .bashrc ë¡œë“œ ë³´ì¥)"
      blockinfile:
        path: "{{ '/home/' + item + '/.bash_profile' if item != 'root' else '/root/.bash_profile' }}"
        marker: "# {mark} ANSIBLE MANAGED BASH PROFILE"
        block: |
          # .bashrcê°€ ìˆìœ¼ë©´ ë¡œë“œ
          if [ -f ~/.bashrc ]; then
              . ~/.bashrc
          fi
        create: yes
        backup: yes
      loop: "{{ target_users }}"

    - name: ".bash_profile ì„¤ì • ê²°ê³¼"
      debug:
        msg: |
          âœ… .bash_profile ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤

    - name: "5ë‹¨ê³„: ì„¤ì • ì ìš© í…ŒìŠ¤íŠ¸"
      shell: |
        echo "=== Bash ì„¤ì • í…ŒìŠ¤íŠ¸ ==="
        echo "í˜„ì¬ ì‚¬ìš©ì: $(whoami)"
        echo "Bash ë²„ì „: $BASH_VERSION"
        echo "History í˜•ì‹: $HISTTIMEFORMAT"
        echo "History í¬ê¸°: $HISTSIZE"
        echo "History íŒŒì¼ í¬ê¸°: $HISTFILESIZE"
        
        echo -e "\n=== Alias í…ŒìŠ¤íŠ¸ ==="
        alias | grep -E "(ll|la)" | head -2 || echo "ê¸°ë³¸ Aliasë§Œ ì„¤ì •ë¨"
        
        echo -e "\n=== Git ë¸Œëœì¹˜ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ==="
        {% if enable_git_branch %}
        if command -v git &> /dev/null; then
            if git rev-parse --git-dir > /dev/null 2>&1; then
                echo "Git ì €ì¥ì†Œì—ì„œ ë¸Œëœì¹˜ í‘œì‹œ: $(parse_git_branch)"
            else
                echo "Git ì €ì¥ì†Œê°€ ì•„ë‹Œ ê²½ìš°: ë¸Œëœì¹˜ í‘œì‹œ ì•ˆí•¨"
            fi
        else
            echo "Gitì´ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ"
        fi
        {% else %}
        echo "Git ë¸Œëœì¹˜ í‘œì‹œê°€ ë¹„í™œì„±í™”ë¨"
        {% endif %}
        
        echo -e "\n=== í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸° ==="
        echo "í”„ë¡¬í”„íŠ¸: $PS1"
      become_user: "{{ item }}"
      loop: "{{ target_users }}"
      register: bash_test
      changed_when: false

    - name: "Bash ì„¤ì • í…ŒìŠ¤íŠ¸ ê²°ê³¼"
      debug:
        msg: |
          ì‚¬ìš©ìë³„ Bash ì„¤ì • í…ŒìŠ¤íŠ¸ ê²°ê³¼:
          {% for result in bash_test.results %}
          
          === {{ result.item }} ì‚¬ìš©ì ===
          {{ result.stdout }}
          {% endfor %}

    - name: "6ë‹¨ê³„: ìƒˆë¡œìš´ íˆìŠ¤í† ë¦¬ ì„¤ì • í™•ì¸"
      shell: |
        echo "=== History ì„¤ì • í™•ì¸ ==="
        echo "HISTTIMEFORMAT ì„¤ì •: $HISTTIMEFORMAT"
        echo "HISTSIZE ì„¤ì •: $HISTSIZE"  
        echo "HISTFILESIZE ì„¤ì •: $HISTFILESIZE"
        echo "History íŒŒì¼ ìœ„ì¹˜: ${HISTFILE:-~/.bash_history}"
        
        if [ -f "${HISTFILE:-~/.bash_history}" ]; then
            echo "History íŒŒì¼ í¬ê¸°: $(wc -l < ${HISTFILE:-~/.bash_history}) ì¤„"
        else
            echo "History íŒŒì¼ì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•ŠìŒ"
        fi
        
        echo -e "\n=== ì„¤ì • ì ìš© í™•ì¸ ==="
        echo "ìƒˆë¡œìš´ ì„¸ì…˜ì—ì„œ history ëª…ë ¹ì–´ê°€ ì‹œê°„ê³¼ í•¨ê»˜ í‘œì‹œë©ë‹ˆë‹¤"
      args:
        executable: /bin/bash
      become_user: "{{ item }}"
      loop: "{{ target_users }}"
      register: history_check
      changed_when: false

    - name: "History ì„¤ì • í™•ì¸ ê²°ê³¼"
      debug:
        msg: |
          ì‚¬ìš©ìë³„ History ì„¤ì • ê²°ê³¼:
          {% for result in history_check.results %}
          
          === {{ result.item }} ì‚¬ìš©ì ===
          {{ result.stdout }}
          {% endfor %}

    - name: "ğŸ‰ Bash ì„¤ì • ì™„ë£Œ ë° ì‚¬ìš© ì•ˆë‚´"
      debug:
        msg: |
          ================================
          ğŸ‰ Bash ì„¤ì • ë° ì»¤ìŠ¤í„°ë§ˆì´ì§• ì™„ë£Œ!
          ================================
          
          âœ… ì ìš©ëœ ì„¤ì •ë“¤:
          â€¢ Historyì— ì‹¤í–‰ ì‹œê°„ í‘œì‹œ (HISTTIMEFORMAT)
          â€¢ History í¬ê¸° ì¦ê°€ ({{ bash_history_size }}ê°œ ëª…ë ¹ì–´)
          â€¢ ì¤‘ë³µ ëª…ë ¹ì–´ ìë™ ì œê±° (HISTCONTROL)
          â€¢ Git ë¸Œëœì¹˜ëª… í”„ë¡¬í”„íŠ¸ í‘œì‹œ (í™œì„±í™”ë¨)
          â€¢ ì»¬ëŸ¬ í”„ë¡¬í”„íŠ¸ (Root: ë¹¨ê°„ìƒ‰, ì‚¬ìš©ì: ì´ˆë¡ìƒ‰)
          
          ğŸ“‹ ìƒˆë¡œìš´ ê¸°ëŠ¥ë“¤:
          
          1. ğŸ• ì‹œê°„ì´ í¬í•¨ëœ History:
             history                       # ì‹œê°„ê³¼ í•¨ê»˜ ëª…ë ¹ì–´ íˆìŠ¤í† ë¦¬ í‘œì‹œ
             
          2. ğŸŒ¿ Git ë¸Œëœì¹˜ í‘œì‹œ:
             # Git ì €ì¥ì†Œì—ì„œ í”„ë¡¬í”„íŠ¸ì— ë¸Œëœì¹˜ëª… ìë™ í‘œì‹œ
             root@proxmox:/path/to/repo (main)$
          
          ğŸ’¡ ì‚¬ìš© ì˜ˆì‹œ:
          
          â€¢ ì‹œê°„ì´ í¬í•¨ëœ ëª…ë ¹ì–´ íˆìŠ¤í† ë¦¬:
            $ history
            2024-09-08 14:30:15  ls -la
            2024-09-08 14:30:22  docker ps
            2024-09-08 14:30:35  git status
            
          â€¢ Git ë¸Œëœì¹˜ê°€ í‘œì‹œë˜ëŠ” í”„ë¡¬í”„íŠ¸:
            root@proxmox:/opt/project (main)$ git checkout develop
            root@proxmox:/opt/project (develop)$
          
          ğŸ”„ ì„¤ì • ì ìš© ë°©ë²•:
          
          1. ìƒˆ í„°ë¯¸ë„ ì„¸ì…˜ ì‹œì‘:
             exit                         # í˜„ì¬ ì„¸ì…˜ ì¢…ë£Œ í›„ ì¬ì ‘ì†
             
          2. ë˜ëŠ” ì„¤ì • ì¦‰ì‹œ ì ìš©:
             source ~/.bashrc             # í˜„ì¬ ì„¸ì…˜ì— ì¦‰ì‹œ ì ìš©
             
          ğŸ“ ë°±ì—… íŒŒì¼:
          â€¢ ê¸°ì¡´ .bashrcëŠ” íƒ€ì„ìŠ¤íƒ¬í”„ì™€ í•¨ê»˜ ë°±ì—…ë¨
          â€¢ ë³µì›ì´ í•„ìš”í•˜ë©´ ë°±ì—… íŒŒì¼ ì‚¬ìš© ê°€ëŠ¥
          
          âš ï¸ ì°¸ê³ ì‚¬í•­:
          â€¢ Root ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ëŠ” ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œ
          â€¢ Git ì €ì¥ì†Œê°€ ì•„ë‹Œ ê³³ì—ì„œëŠ” ë¸Œëœì¹˜ í‘œì‹œ ì•ˆí•¨
          â€¢ HistoryëŠ” ì—¬ëŸ¬ ì„¸ì…˜ì—ì„œ ì‹¤ì‹œê°„ ê³µìœ ë¨
          â€¢ ëª¨ë“  ì„¤ì •ì€ ì‚¬ìš©ìë³„ë¡œ ê°œë³„ ì ìš©
          
          ================================
