---
- name: "Docker ë° Docker Compose ì„¤ì¹˜"
  hosts: proxmox
  gather_facts: yes
    
  tasks:
    - name: "=== Docker & Docker Compose ì„¤ì¹˜ ì‹œì‘ ==="
      debug:
        msg: |
          ================================
          Docker & Docker Compose ìë™ ì„¤ì¹˜
          ================================
          
          ğŸ¯ ëª©ì : ProxMox ì„œë²„ì— ì»¨í…Œì´ë„ˆ í™˜ê²½ êµ¬ì¶•
          ğŸ“‹ ì„¤ì¹˜ ê³¼ì •:
          â€¢ Docker CE (Community Edition)
          â€¢ Docker Compose (ìµœì‹  ë²„ì „)
          â€¢ Docker ì„œë¹„ìŠ¤ ì„¤ì • ë° í™œì„±í™”
          â€¢ ì‚¬ìš©ì ê¶Œí•œ ì„¤ì • (ì„ íƒì‚¬í•­)
          
          ğŸ³ ì£¼ìš” ê¸°ëŠ¥:
          â€¢ ì»¨í…Œì´ë„ˆ ê¸°ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
          â€¢ Docker Composeë¡œ ë©€í‹° ì»¨í…Œì´ë„ˆ ê´€ë¦¬
          â€¢ ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬
          
          â±ï¸ ì˜ˆìƒ ì†Œìš”ì‹œê°„: 3-5ë¶„
          ================================

    - name: "1ë‹¨ê³„: ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸"
      debug:
        msg: |
          ì‹œìŠ¤í…œ ì •ë³´:
          - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          - ì•„í‚¤í…ì²˜: {{ ansible_architecture }}
          - ì»¤ë„: {{ ansible_kernel }}
          - ë©”ëª¨ë¦¬: {{ ansible_memfree_mb }}MB ì‚¬ìš© ê°€ëŠ¥

    - name: "2ë‹¨ê³„: ê¸°ì¡´ Docker íŒ¨í‚¤ì§€ ì œê±° (ì¶©ëŒ ë°©ì§€)"
      apt:
        name:
          - docker.io
          - docker-doc
          - docker-compose
          - podman-docker
          - containerd
          - runc
        state: absent
        purge: yes
      register: old_docker_removal
      failed_when: false

    - name: "ê¸°ì¡´ íŒ¨í‚¤ì§€ ì œê±° ê²°ê³¼"
      debug:
        msg: |
          {{ 'âœ… ê¸°ì¡´ Docker íŒ¨í‚¤ì§€ ì œê±° ì™„ë£Œ' if old_docker_removal.changed else 'âœ… ì œê±°í•  ê¸°ì¡´ íŒ¨í‚¤ì§€ ì—†ìŒ' }}

    - name: "3ë‹¨ê³„: í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (Docker ì €ì¥ì†Œ ì¶”ê°€ìš©)"
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - apt-transport-https
        state: present
        update_cache: yes
      register: prereq_install

    - name: "í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ê²°ê³¼"
      debug:
        msg: |
          {{ 'âœ… í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ' if prereq_install.changed else 'âœ… í•„ìˆ˜ íŒ¨í‚¤ì§€ê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŒ' }}

    - name: "4ë‹¨ê³„: Docker GPG í‚¤ ë””ë ‰í„°ë¦¬ ìƒì„±"
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: "5ë‹¨ê³„: Docker GPG í‚¤ ë‹¤ìš´ë¡œë“œ ë° ì¶”ê°€"
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg
      register: docker_gpg_key

    - name: "GPG í‚¤ ì¶”ê°€ ê²°ê³¼"
      debug:
        msg: |
          {{ 'âœ… Docker GPG í‚¤ ì¶”ê°€ ì™„ë£Œ' if docker_gpg_key.changed else 'âœ… Docker GPG í‚¤ê°€ ì´ë¯¸ ì¡´ì¬í•¨' }}

    - name: "6ë‹¨ê³„: Docker APT ì €ì¥ì†Œ ì¶”ê°€"
      shell: |
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
      args:
        creates: /etc/apt/sources.list.d/docker.list
      register: docker_repo_add

    - name: "ì €ì¥ì†Œ ì¶”ê°€ ê²°ê³¼"
      debug:
        msg: |
          {{ 'âœ… Docker ì €ì¥ì†Œ ì¶”ê°€ ì™„ë£Œ' if docker_repo_add.changed else 'âœ… Docker ì €ì¥ì†Œê°€ ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆìŒ' }}

    - name: "7ë‹¨ê³„: APT íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸ (Docker ì €ì¥ì†Œ ë°˜ì˜)"
      apt:
        update_cache: yes
      register: apt_update

    - name: "APT ì—…ë°ì´íŠ¸ ê²°ê³¼"
      debug:
        msg: |
          âœ… Docker ì €ì¥ì†Œ íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸ ì™„ë£Œ

    - name: "8ë‹¨ê³„: Docker CE ì„¤ì¹˜"
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
        state: present
        update_cache: no
      register: docker_install

    - name: "Docker CE ì„¤ì¹˜ ê²°ê³¼"
      debug:
        msg: |
          {{ 'âœ… Docker CE ì„¤ì¹˜ ì™„ë£Œ' if docker_install.changed else 'âœ… Docker CEê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŒ' }}

    - name: "9ë‹¨ê³„: Docker ì„œë¹„ìŠ¤ í™œì„±í™” ë° ì‹œì‘"
      systemd:
        name: docker
        enabled: yes
        state: started
      register: docker_service

    - name: "Docker ì„œë¹„ìŠ¤ í™œì„±í™” ê²°ê³¼"
      debug:
        msg: |
          âœ… Docker ì„œë¹„ìŠ¤ í™œì„±í™” ë° ì‹œì‘ ì™„ë£Œ

    - name: "Docker Compose ë²„ì „ ì„¤ì •"
      set_fact:
        compose_version_target: "{{ docker_compose_version | default('latest') }}"

    - name: "10ë‹¨ê³„: Docker Compose ìµœì‹  ë²„ì „ í™•ì¸"
      uri:
        url: https://api.github.com/repos/docker/compose/releases/latest
        method: GET
        return_content: yes
      register: compose_latest_release
      when: compose_version_target == "latest"

    - name: "Docker Compose ë‹¤ìš´ë¡œë“œ ë²„ì „ ê²°ì •"
      set_fact:
        compose_download_version: "{{ compose_latest_release.json.tag_name if compose_version_target == 'latest' else compose_version_target }}"

    - name: "11ë‹¨ê³„: Docker Compose ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜"
      get_url:
        url: "https://github.com/docker/compose/releases/download/{{ compose_download_version }}/docker-compose-linux-{{ ansible_architecture }}"
        dest: /usr/local/bin/docker-compose
        mode: '0755'
        owner: root
        group: root
      register: compose_install

    - name: "Docker Compose ì„¤ì¹˜ ê²°ê³¼"
      debug:
        msg: |
          {{ 'âœ… Docker Compose ì„¤ì¹˜ ì™„ë£Œ' if compose_install.changed else 'âœ… Docker Composeê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŒ' }}

    - name: "12ë‹¨ê³„: Docker Compose ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„±"
      file:
        src: /usr/local/bin/docker-compose
        dest: /usr/bin/docker-compose
        state: link
      register: compose_symlink

    - name: "ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„± ê²°ê³¼"
      debug:
        msg: |
          {{ 'âœ… Docker Compose ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„± ì™„ë£Œ' if compose_symlink.changed else 'âœ… ì‹¬ë³¼ë¦­ ë§í¬ê°€ ì´ë¯¸ ì¡´ì¬í•¨' }}

    - name: "13ë‹¨ê³„: Docker ë° Docker Compose ì„¤ì¹˜ í™•ì¸"
      shell: |
        echo "=== Docker ì„¤ì¹˜ ì •ë³´ ==="
        echo "Docker ë²„ì „: $(docker --version 2>/dev/null || echo 'ì„¤ì¹˜ í™•ì¸ ë¶ˆê°€')"
        echo "Docker Compose ë²„ì „: $(docker-compose --version 2>/dev/null || echo 'ì„¤ì¹˜ í™•ì¸ ë¶ˆê°€')"
        
        echo -e "\n=== Docker ì„œë¹„ìŠ¤ ìƒíƒœ ==="
        systemctl is-active docker && echo "âœ… Docker ì„œë¹„ìŠ¤: ì‹¤í–‰ ì¤‘" || echo "âŒ Docker ì„œë¹„ìŠ¤: ì¤‘ì§€ë¨"
        systemctl is-enabled docker && echo "âœ… Docker ì„œë¹„ìŠ¤: ìë™ ì‹œì‘ í™œì„±í™”ë¨" || echo "âŒ Docker ì„œë¹„ìŠ¤: ìë™ ì‹œì‘ ë¹„í™œì„±í™”ë¨"
        
        echo -e "\n=== Docker ì •ë³´ ==="
        docker info 2>/dev/null | head -5 && echo "âœ… Docker ë°ëª¬ ì—°ê²° ì„±ê³µ" || echo "âŒ Docker ë°ëª¬ ì—°ê²° ì‹¤íŒ¨"
        
        echo -e "\n=== ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ==="
        df -h /var/lib/docker 2>/dev/null | tail -1 | awk '{print "Docker ì €ì¥ì†Œ: " $4 " ì‚¬ìš© ê°€ëŠ¥"}' || echo "Docker ì €ì¥ì†Œ: /var/lib/docker í™•ì¸ ë¶ˆê°€"
      register: docker_status
      changed_when: false

    - name: "Docker ìƒíƒœ í™•ì¸ ê²°ê³¼"
      debug:
        msg: |
          í˜„ì¬ Docker ìƒíƒœ:
          {{ docker_status.stdout }}

    - name: "14ë‹¨ê³„: Docker ê·¸ë£¹ì— ì‚¬ìš©ì ì¶”ê°€ (ì„ íƒì‚¬í•­)"
      user:
        name: "{{ item }}"
        groups: docker
        append: yes
      loop: "{{ docker_users | default([]) }}"
      when: (docker_users | default([])) | length > 0
      register: user_docker_group

    - name: "ì‚¬ìš©ì ê·¸ë£¹ ì¶”ê°€ ê²°ê³¼"
      debug:
        msg: |
          {{ 'âœ… ì‚¬ìš©ìë“¤ì„ Docker ê·¸ë£¹ì— ì¶”ê°€ ì™„ë£Œ: ' + ((docker_users | default([])) | join(', ')) if (docker_users | default([])) | length > 0 else 'â­ï¸ ì¶”ê°€í•  ì‚¬ìš©ì ì—†ìŒ' }}

    - name: "15ë‹¨ê³„: Docker Compose í…ŒìŠ¤íŠ¸"
      shell: |
        mkdir -p /tmp/docker-test
        cd /tmp/docker-test
        cat > docker-compose.yml << 'EOF'
        version: '3.8'
        services:
          hello-world:
            image: hello-world:latest
        EOF
        docker-compose config --quiet && echo "âœ… Docker Compose ì„¤ì • íŒŒì¼ ê²€ì¦ ì„±ê³µ" || echo "âŒ Docker Compose ì„¤ì • íŒŒì¼ ê²€ì¦ ì‹¤íŒ¨"
        rm -rf /tmp/docker-test
      register: compose_test
      changed_when: false

    - name: "Docker Compose í…ŒìŠ¤íŠ¸ ê²°ê³¼"
      debug:
        msg: |
          {{ compose_test.stdout }}

    - name: "ğŸ‰ Docker & Docker Compose ì„¤ì¹˜ ì™„ë£Œ ë° ì‚¬ìš© ì•ˆë‚´"
      debug:
        msg: |
          ================================
          ğŸ‰ Docker & Docker Compose ì„¤ì¹˜ ì™„ë£Œ!
          ================================
          
          âœ… ì„¤ì¹˜ ì™„ë£Œëœ êµ¬ì„± ìš”ì†Œ:
          â€¢ Docker CE (Community Edition)
          â€¢ Docker Compose (ìµœì‹  ë²„ì „)
          â€¢ Docker ë°ëª¬ ì„œë¹„ìŠ¤ (ìë™ ì‹œì‘)
          â€¢ í•„ìš”í•œ ëª¨ë“  í”ŒëŸ¬ê·¸ì¸ ë° ë„êµ¬
          
          ğŸ“‹ ê¸°ë³¸ Docker ëª…ë ¹ì–´:
          
          1. ğŸ³ ì»¨í…Œì´ë„ˆ ì‹¤í–‰:
             docker run hello-world
             docker run -d -p 80:80 nginx
             
          2. ğŸ“¦ ì´ë¯¸ì§€ ê´€ë¦¬:
             docker images                 # ì´ë¯¸ì§€ ëª©ë¡
             docker pull <ì´ë¯¸ì§€ëª…>        # ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
             docker rmi <ì´ë¯¸ì§€ëª…>         # ì´ë¯¸ì§€ ì‚­ì œ
             
          3. ğŸ”„ ì»¨í…Œì´ë„ˆ ê´€ë¦¬:
             docker ps                     # ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ
             docker ps -a                  # ëª¨ë“  ì»¨í…Œì´ë„ˆ
             docker stop <ì»¨í…Œì´ë„ˆID>      # ì»¨í…Œì´ë„ˆ ì¤‘ì§€
             docker rm <ì»¨í…Œì´ë„ˆID>        # ì»¨í…Œì´ë„ˆ ì‚­ì œ
          
          ğŸ“‹ Docker Compose ëª…ë ¹ì–´:
          
          1. ğŸš€ ì„œë¹„ìŠ¤ ì‹¤í–‰:
             docker-compose up -d          # ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
             docker-compose down           # ì„œë¹„ìŠ¤ ì¤‘ì§€ ë° ì œê±°
             
          2. ğŸ“Š ìƒíƒœ í™•ì¸:
             docker-compose ps             # ì„œë¹„ìŠ¤ ìƒíƒœ
             docker-compose logs           # ì„œë¹„ìŠ¤ ë¡œê·¸
             
          3. âš™ï¸ ê´€ë¦¬:
             docker-compose restart        # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
             docker-compose pull           # ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
          
          ğŸ’¡ ìœ ìš©í•œ Docker ëª…ë ¹ì–´:
          
          â€¢ ì‹œìŠ¤í…œ ì •ë³´:
            docker info
            docker system df              # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰
            
          â€¢ ì •ë¦¬ ì‘ì—…:
            docker system prune           # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ ì •ë¦¬
            docker container prune        # ì¤‘ì§€ëœ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker image prune            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
            
          â€¢ ë¡œê·¸ í™•ì¸:
            docker logs <ì»¨í…Œì´ë„ˆëª…>
            docker logs -f <ì»¨í…Œì´ë„ˆëª…>   # ì‹¤ì‹œê°„ ë¡œê·¸
          
          ğŸ—ï¸ ProxMoxì—ì„œ Docker í™œìš© ì˜ˆì‹œ:
          
          1. ì›¹ ì„œë²„ ì‹¤í–‰:
             docker run -d -p 8080:80 --name nginx nginx
             
          2. ë°ì´í„°ë² ì´ìŠ¤ ì‹¤í–‰:
             docker run -d -p 3306:3306 --name mysql \
               -e MYSQL_ROOT_PASSWORD=password mysql
               
          3. ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ:
             # Portainer (Docker GUI ê´€ë¦¬)
             docker run -d -p 9000:9000 --name portainer \
               -v /var/run/docker.sock:/var/run/docker.sock \
               portainer/portainer-ce
          
          ğŸ”§ ë¬¸ì œ í•´ê²°:
          
          â€¢ Docker ì„œë¹„ìŠ¤ ì¬ì‹œì‘:
            sudo systemctl restart docker
            
          â€¢ ê¶Œí•œ ë¬¸ì œ í•´ê²° (ì¬ë¡œê·¸ì¸ í•„ìš”):
            sudo usermod -aG docker $USER
            
          â€¢ ì €ì¥ì†Œ ê³µê°„ ë¶€ì¡±:
            docker system prune -a
            
          â€¢ ì„¤ì • í™•ì¸:
            docker info
            docker version
          
          âš ï¸ ë³´ì•ˆ ê¶Œì¥ì‚¬í•­:
          
          â€¢ Docker ë°ëª¬ì€ root ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤
          â€¢ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì´ë¯¸ì§€ë§Œ ì‚¬ìš©í•˜ì„¸ìš”
          â€¢ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ë³´ì•ˆ ìŠ¤ìº”ì„ ìˆ˜í–‰í•˜ì„¸ìš”
          â€¢ ë„¤íŠ¸ì›Œí¬ í¬íŠ¸ ë…¸ì¶œì„ ìµœì†Œí™”í•˜ì„¸ìš”
          
          ğŸŒŸ ë‹¤ìŒ ë‹¨ê³„:
          
          â€¢ Portainer ì„¤ì¹˜ë¡œ ì›¹ GUI ê´€ë¦¬: http://<ì„œë²„IP>:9000
          â€¢ Docker Composeë¡œ ë©€í‹° ì»¨í…Œì´ë„ˆ ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì„±
          â€¢ Docker Registry êµ¬ì¶•ìœ¼ë¡œ í”„ë¼ì´ë¹— ì´ë¯¸ì§€ ì €ì¥ì†Œ ìš´ì˜
          â€¢ CI/CD íŒŒì´í”„ë¼ì¸ êµ¬ì¶•ìœ¼ë¡œ ìë™ ë°°í¬
          
          ================================
