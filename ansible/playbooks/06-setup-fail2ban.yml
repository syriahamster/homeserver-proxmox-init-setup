---
- name: "Fail2ban ë³´ì•ˆ ì„¤ì •"
  hosts: proxmox
  gather_facts: yes
  vars:
    # Fail2ban ê¸°ë³¸ ì„¤ì •
    fail2ban_bantime: 3600      # ì°¨ë‹¨ ì‹œê°„ (ì´ˆ) - 1ì‹œê°„
    fail2ban_findtime: 600      # ê°ì§€ ì‹œê°„ (ì´ˆ) - 10ë¶„
    fail2ban_maxretry: 3        # ìµœëŒ€ ì‹¤íŒ¨ íšŸìˆ˜
    fail2ban_ignoreip:          # ì°¨ë‹¨ ì œì™¸ IP ëª©ë¡
      - "127.0.0.1/8"
      - "::1"
      - "192.168.0.0/16"        # ë¡œì»¬ ë„¤íŠ¸ì›Œí¬ (í•„ìš”ì— ë”°ë¼ ìˆ˜ì •)
      - "10.0.0.0/8"
      - "172.16.0.0/12"
    
    # í™œì„±í™”í•  jail ëª©ë¡
    fail2ban_jails:
      - name: "sshd"
        enabled: true
        port: "22"
        logpath: "/var/log/auth.log"
      - name: "sshd-ddos"
        enabled: true
        port: "22"
        logpath: "/var/log/auth.log"
    
  tasks:
    - name: "=== Fail2ban ë³´ì•ˆ ì„¤ì • ì‹œì‘ ==="
      debug:
        msg: |
          ================================
          Fail2ban ì¹¨ì… ì°¨ë‹¨ ì‹œìŠ¤í…œ ì„¤ì¹˜
          ================================
          
          ğŸ¯ ëª©ì : ProxMox ì„œë²„ ë³´ì•ˆ ê°•í™”
          ğŸ“‹ ì„¤ì¹˜ ë° ì„¤ì • ë‚´ìš©:
          â€¢ Fail2ban ì¹¨ì… ì°¨ë‹¨ ì‹œìŠ¤í…œ ì„¤ì¹˜
          â€¢ SSH ë¸Œë£¨íŠ¸í¬ìŠ¤ ê³µê²© ì°¨ë‹¨
          â€¢ ê¸°ë³¸ ë³´ì•ˆ ì •ì±… ì„¤ì •
          â€¢ ë¡œì»¬ ë„¤íŠ¸ì›Œí¬ ì˜ˆì™¸ ì²˜ë¦¬
          â€¢ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ í™œì„±í™”
          
          âš™ï¸ ì£¼ìš” ì„¤ì •:
          â€¢ ì°¨ë‹¨ ì‹œê°„: {{ fail2ban_bantime }}ì´ˆ ({{ (fail2ban_bantime / 60) | int }}ë¶„)
          â€¢ ê°ì§€ ì‹œê°„: {{ fail2ban_findtime }}ì´ˆ ({{ (fail2ban_findtime / 60) | int }}ë¶„)
          â€¢ ìµœëŒ€ ì‹¤íŒ¨: {{ fail2ban_maxretry }}íšŒ
          
          â±ï¸ ì˜ˆìƒ ì†Œìš”ì‹œê°„: 2-3ë¶„
          ================================

    - name: "1ë‹¨ê³„: ì‹œìŠ¤í…œ ì •ë³´ ë° í˜„ì¬ ë³´ì•ˆ ìƒíƒœ í™•ì¸"
      debug:
        msg: |
          ì‹œìŠ¤í…œ ì •ë³´:
          - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          - ì•„í‚¤í…ì²˜: {{ ansible_architecture }}
          - í˜„ì¬ ì‹œê°„: {{ ansible_date_time.iso8601 }}
          - SSH í¬íŠ¸: 22 (ê¸°ë³¸ê°’)

    - name: "2ë‹¨ê³„: ê¸°ì¡´ Fail2ban ìƒíƒœ í™•ì¸"
      shell: |
        echo "=== í˜„ì¬ ìƒíƒœ í™•ì¸ ==="
        if systemctl is-active fail2ban >/dev/null 2>&1; then
            echo "Fail2ban ì„œë¹„ìŠ¤: ì‹¤í–‰ ì¤‘"
            fail2ban-client status 2>/dev/null || echo "í´ë¼ì´ì–¸íŠ¸ ëª…ë ¹ ì‚¬ìš© ë¶ˆê°€"
        else
            echo "Fail2ban ì„œë¹„ìŠ¤: ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ ë˜ëŠ” ì¤‘ì§€ë¨"
        fi
        
        echo -e "\n=== í˜„ì¬ ì°¨ë‹¨ëœ IP í™•ì¸ ==="
        iptables -L -n | grep -i reject | head -5 || echo "í˜„ì¬ ì°¨ë‹¨ëœ IP ì—†ìŒ"
      register: fail2ban_status_check
      changed_when: false
      failed_when: false

    - name: "í˜„ì¬ ë³´ì•ˆ ìƒíƒœ"
      debug:
        msg: |
          í˜„ì¬ Fail2ban ìƒíƒœ:
          {{ fail2ban_status_check.stdout }}

    - name: "3ë‹¨ê³„: APT íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸"
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: "4ë‹¨ê³„: Fail2ban ë° í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜"
      apt:
        name:
          - fail2ban
          - iptables
          - iptables-persistent
        state: present
      register: fail2ban_install

    - name: "Fail2ban ì„¤ì¹˜ ê²°ê³¼"
      debug:
        msg: |
          {{ 'âœ… Fail2ban ë° ê´€ë ¨ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ' if fail2ban_install.changed else 'âœ… Fail2banì´ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŒ' }}

    - name: "5ë‹¨ê³„: Fail2ban ì„¤ì • ë””ë ‰í„°ë¦¬ ìƒì„±"
      file:
        path: /etc/fail2ban
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: "6ë‹¨ê³„: Fail2ban ê¸°ë³¸ ì„¤ì • íŒŒì¼ ìƒì„± (/etc/fail2ban/jail.local)"
      copy:
        dest: /etc/fail2ban/jail.local
        owner: root
        group: root
        mode: '0644'
        backup: yes
        content: |
          # Fail2ban ê¸°ë³¸ ì„¤ì • - ProxMox ì„œë²„ìš©
          # ì´ íŒŒì¼ì€ Ansibleì— ì˜í•´ ìë™ ìƒì„±ë¨
          
          [DEFAULT]
          # ê¸°ë³¸ ì°¨ë‹¨ ì‹œê°„ (ì´ˆ)
          bantime = {{ fail2ban_bantime }}
          
          # ê°ì§€ ì‹œê°„ ìœˆë„ìš° (ì´ˆ)
          findtime = {{ fail2ban_findtime }}
          
          # ìµœëŒ€ ì‹¤íŒ¨ íšŸìˆ˜
          maxretry = {{ fail2ban_maxretry }}
          
          # ì°¨ë‹¨ ì œì™¸ IP ëª©ë¡
          ignoreip = {{ fail2ban_ignoreip | join(' ') }}
          
          # ì°¨ë‹¨ ì•¡ì…˜ (iptables ì‚¬ìš©)
          banaction = iptables-multiport
          banaction_allports = iptables-allports
          
          # ë¡œê·¸ ë ˆë²¨
          loglevel = INFO
          
          # ë¡œê·¸ íŒŒì¼ ìœ„ì¹˜
          logtarget = /var/log/fail2ban.log
          
          # ====================================
          # SSH ë³´ì•ˆ ì„¤ì •
          # ====================================
          
          [sshd]
          enabled = true
          port = ssh
          logpath = /var/log/auth.log
          maxretry = {{ fail2ban_maxretry }}
          bantime = {{ fail2ban_bantime }}
          findtime = {{ fail2ban_findtime }}
          
          [sshd-ddos]
          enabled = true
          port = ssh
          logpath = /var/log/auth.log
          maxretry = 2
          bantime = {{ fail2ban_bantime * 2 }}
          findtime = {{ fail2ban_findtime }}
          
          # ====================================
          # ProxMox ì›¹ ì¸í„°í˜ì´ìŠ¤ ë³´ì•ˆ (ì„ íƒì‚¬í•­)
          # ====================================
          
          [proxmox]
          enabled = false
          port = https,http,8006
          logpath = /var/log/daemon.log
          maxretry = 3
          bantime = {{ fail2ban_bantime }}
          
          # ====================================
          # ì¶”ê°€ ë³´ì•ˆ ì„¤ì • (ë¹„í™œì„±í™”ë¨)
          # ====================================
          
          [apache-auth]
          enabled = false
          
          [apache-badbots]
          enabled = false
          
          [apache-noscript]
          enabled = false
          
          [nginx-http-auth]
          enabled = false
      register: jail_config

    - name: "Fail2ban ì„¤ì • íŒŒì¼ ìƒì„± ê²°ê³¼"
      debug:
        msg: |
          {{ 'âœ… ìƒˆë¡œìš´ jail.local ì„¤ì • íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤' if jail_config.changed else 'âœ… jail.local ì„¤ì • íŒŒì¼ì´ ì´ë¯¸ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤' }}

    - name: "7ë‹¨ê³„: Fail2ban ì„œë¹„ìŠ¤ í™œì„±í™” ë° ì‹œì‘"
      systemd:
        name: fail2ban
        enabled: yes
        state: restarted
        daemon_reload: yes
      register: fail2ban_service

    - name: "Fail2ban ì„œë¹„ìŠ¤ í™œì„±í™” ê²°ê³¼"
      debug:
        msg: |
          âœ… Fail2ban ì„œë¹„ìŠ¤ê°€ í™œì„±í™”ë˜ê³  ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤

    - name: "8ë‹¨ê³„: Fail2ban ìƒíƒœ ë° jail í™•ì¸"
      shell: |
        echo "=== Fail2ban ì„œë¹„ìŠ¤ ìƒíƒœ ==="
        systemctl is-active fail2ban && echo "âœ… fail2ban ì„œë¹„ìŠ¤: ì‹¤í–‰ ì¤‘" || echo "âŒ fail2ban ì„œë¹„ìŠ¤: ì¤‘ì§€ë¨"
        systemctl is-enabled fail2ban && echo "âœ… fail2ban ì„œë¹„ìŠ¤: ìë™ ì‹œì‘ í™œì„±í™”" || echo "âŒ fail2ban ì„œë¹„ìŠ¤: ìë™ ì‹œì‘ ë¹„í™œì„±í™”"
        
        echo -e "\n=== í™œì„±í™”ëœ Jail ëª©ë¡ ==="
        fail2ban-client status 2>/dev/null || echo "fail2ban í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì‹¤íŒ¨"
        
        echo -e "\n=== SSH Jail ìƒì„¸ ì •ë³´ ==="
        fail2ban-client status sshd 2>/dev/null || echo "sshd jail ì •ë³´ í™•ì¸ ë¶ˆê°€"
        
        echo -e "\n=== ë¡œê·¸ íŒŒì¼ í™•ì¸ ==="
        if [ -f /var/log/fail2ban.log ]; then
            echo "Fail2ban ë¡œê·¸ íŒŒì¼: ì¡´ì¬í•¨"
            tail -3 /var/log/fail2ban.log 2>/dev/null || echo "ë¡œê·¸ ì½ê¸° ì‹¤íŒ¨"
        else
            echo "Fail2ban ë¡œê·¸ íŒŒì¼: ì•„ì§ ìƒì„±ë˜ì§€ ì•ŠìŒ"
        fi
      register: fail2ban_status
      changed_when: false

    - name: "Fail2ban ìƒíƒœ í™•ì¸ ê²°ê³¼"
      debug:
        msg: |
          í˜„ì¬ Fail2ban ìƒíƒœ:
          {{ fail2ban_status.stdout }}

    - name: "9ë‹¨ê³„: iptables ê·œì¹™ í™•ì¸"
      shell: |
        echo "=== í˜„ì¬ iptables ê·œì¹™ ==="
        echo "INPUT ì²´ì¸ì˜ fail2ban ê·œì¹™:"
        iptables -L INPUT -v -n | grep -i fail2ban || echo "ì•„ì§ fail2ban ê·œì¹™ì´ ìƒì„±ë˜ì§€ ì•ŠìŒ"
        
        echo -e "\n=== ì°¨ë‹¨ëœ IP í™•ì¸ ==="
        iptables -L -n | grep -E "(REJECT|DROP)" | head -3 || echo "í˜„ì¬ ì°¨ë‹¨ëœ IP ì—†ìŒ"
        
        echo -e "\n=== fail2ban-clientë¡œ ì°¨ë‹¨ IP í™•ì¸ ==="
        fail2ban-client status sshd 2>/dev/null | grep -E "Banned IP list|Currently banned" || echo "sshd jailì—ì„œ ì°¨ë‹¨ëœ IP ì—†ìŒ"
      register: iptables_check
      changed_when: false

    - name: "iptables ê·œì¹™ í™•ì¸ ê²°ê³¼"
      debug:
        msg: |
          í˜„ì¬ ë°©í™”ë²½ ìƒíƒœ:
          {{ iptables_check.stdout }}

    - name: "10ë‹¨ê³„: Fail2ban í…ŒìŠ¤íŠ¸ ì¤€ë¹„ (ì•ˆì „í•œ í…ŒìŠ¤íŠ¸)"
      shell: |
        echo "=== Fail2ban ì„¤ì • í…ŒìŠ¤íŠ¸ ==="
        echo "ì„¤ì • íŒŒì¼ ë¬¸ë²• ê²€ì‚¬:"
        fail2ban-client -t 2>/dev/null && echo "âœ… ì„¤ì • íŒŒì¼ ë¬¸ë²• ì˜¬ë°”ë¦„" || echo "âŒ ì„¤ì • íŒŒì¼ì— ì˜¤ë¥˜ ìˆìŒ"
        
        echo -e "\n=== í™œì„± í•„í„° í™•ì¸ ==="
        fail2ban-client status 2>/dev/null | head -10
        
        echo -e "\n=== ëª¨ë‹ˆí„°ë§ ì¤‘ì¸ ë¡œê·¸ íŒŒì¼ ==="
        ls -la /var/log/auth.log /var/log/fail2ban.log 2>/dev/null || echo "ì¼ë¶€ ë¡œê·¸ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ"
      register: fail2ban_test
      changed_when: false

    - name: "Fail2ban í…ŒìŠ¤íŠ¸ ê²°ê³¼"
      debug:
        msg: |
          Fail2ban ì„¤ì • í…ŒìŠ¤íŠ¸:
          {{ fail2ban_test.stdout }}

    - name: "ğŸ‰ Fail2ban ë³´ì•ˆ ì„¤ì • ì™„ë£Œ ë° ì‚¬ìš© ì•ˆë‚´"
      debug:
        msg: |
          ================================
          ğŸ‰ Fail2ban ë³´ì•ˆ ì„¤ì • ì™„ë£Œ!
          ================================
          
          âœ… ì„¤ì¹˜ ë° ì„¤ì • ì™„ë£Œ:
          â€¢ Fail2ban ì¹¨ì… ì°¨ë‹¨ ì‹œìŠ¤í…œ ì„¤ì¹˜
          â€¢ SSH ë¸Œë£¨íŠ¸í¬ìŠ¤ ê³µê²© ì°¨ë‹¨ í™œì„±í™”
          â€¢ iptables ë°©í™”ë²½ ê·œì¹™ ìë™ ê´€ë¦¬
          â€¢ ì‹¤ì‹œê°„ ë¡œê·¸ ëª¨ë‹ˆí„°ë§ ì‹œì‘
          â€¢ ìë™ ì‹œì‘ ì„œë¹„ìŠ¤ ë“±ë¡
          
          âš™ï¸ ì ìš©ëœ ë³´ì•ˆ ì •ì±…:
          â€¢ ì°¨ë‹¨ ì‹œê°„: {{ (fail2ban_bantime / 60) | int }}ë¶„
          â€¢ ê°ì§€ ì‹œê°„: {{ (fail2ban_findtime / 60) | int }}ë¶„ ë‚´ì—
          â€¢ ìµœëŒ€ {{ fail2ban_maxretry }}íšŒ ì‹¤íŒ¨ ì‹œ ì°¨ë‹¨
          â€¢ ë¡œì»¬ ë„¤íŠ¸ì›Œí¬ëŠ” ì°¨ë‹¨ ì œì™¸
          
          ğŸ“‹ ì£¼ìš” ëª…ë ¹ì–´:
          
          1. ğŸ” ìƒíƒœ í™•ì¸:
             fail2ban-client status           # ì „ì²´ ìƒíƒœ
             fail2ban-client status sshd      # SSH jail ìƒíƒœ
             
          2. ğŸ“Š ì°¨ë‹¨ ëª©ë¡ í™•ì¸:
             fail2ban-client status sshd | grep "Banned IP"
             iptables -L -n | grep fail2ban
             
          3. ğŸ”“ IP ì°¨ë‹¨ í•´ì œ:
             fail2ban-client set sshd unbanip <IPì£¼ì†Œ>
             
          4. ğŸš« ìˆ˜ë™ IP ì°¨ë‹¨:
             fail2ban-client set sshd banip <IPì£¼ì†Œ>
             
          5. ğŸ“œ ë¡œê·¸ í™•ì¸:
             tail -f /var/log/fail2ban.log    # ì‹¤ì‹œê°„ ë¡œê·¸
             tail -f /var/log/auth.log        # SSH ì¸ì¦ ë¡œê·¸
             
          6. âš™ï¸ ì„œë¹„ìŠ¤ ê´€ë¦¬:
             systemctl status fail2ban        # ì„œë¹„ìŠ¤ ìƒíƒœ
             systemctl restart fail2ban       # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          
          ğŸ”§ ì„¤ì • íŒŒì¼ ìœ„ì¹˜:
          â€¢ ì£¼ ì„¤ì •: /etc/fail2ban/jail.local
          â€¢ ê¸°ë³¸ ì„¤ì •: /etc/fail2ban/jail.conf (ìˆ˜ì • ê¸ˆì§€)
          â€¢ ë¡œê·¸ íŒŒì¼: /var/log/fail2ban.log
          
          ğŸ’¡ ë³´ì•ˆ íŒ:
          
          â€¢ SSH í‚¤ ì¸ì¦ ì‚¬ìš© ê¶Œì¥ (ì´ë¯¸ ì„¤ì •ë¨)
          â€¢ ê¸°ë³¸ SSH í¬íŠ¸(22) ë³€ê²½ ê³ ë ¤
          â€¢ ì •ê¸°ì ì¸ ë¡œê·¸ ëª¨ë‹ˆí„°ë§ í•„ìš”
          â€¢ VPN ì‚¬ìš© ì‹œ VPN IP ì˜ˆì™¸ ì²˜ë¦¬
          
          ğŸš¨ ì£¼ì˜ì‚¬í•­:
          
          â€¢ ë³¸ì¸ IPê°€ ì°¨ë‹¨ë˜ë©´ SSH ì ‘ì† ë¶ˆê°€
          â€¢ ì°¨ë‹¨ í•´ì œëŠ” ì›¹ ì½˜ì†” ë˜ëŠ” ë¬¼ë¦¬ì  ì ‘ê·¼ í•„ìš”
          â€¢ ë¡œì»¬ ë„¤íŠ¸ì›Œí¬({{ fail2ban_ignoreip | join(', ') }})ëŠ” ì°¨ë‹¨ ì œì™¸
          â€¢ ì„¤ì • ë³€ê²½ í›„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ í•„ìš”
          
          ğŸ“ˆ ëª¨ë‹ˆí„°ë§ ë°©ë²•:
          
          â€¢ ì‹¤ì‹œê°„ ì°¨ë‹¨ ë¡œê·¸:
            tail -f /var/log/fail2ban.log | grep Ban
            
          â€¢ SSH ê³µê²© ì‹œë„ í™•ì¸:
            grep "Failed password" /var/log/auth.log | tail -10
            
          â€¢ í˜„ì¬ ì°¨ë‹¨ëœ IP ê°œìˆ˜:
            fail2ban-client status sshd | grep "Currently banned"
          
          ğŸ”’ ProxMox ë³´ì•ˆ ì™„ì„±ë„:
          1ï¸âƒ£ SSH í‚¤ ì¸ì¦ âœ…
          2ï¸âƒ£ íŒ¨ìŠ¤ì›Œë“œ ì¸ì¦ ë¹„í™œì„±í™” âœ…  
          3ï¸âƒ£ APT ì €ì¥ì†Œ ë³´ì•ˆ âœ…
          4ï¸âƒ£ Fail2ban ì¹¨ì… ì°¨ë‹¨ âœ…
          
          ================================
